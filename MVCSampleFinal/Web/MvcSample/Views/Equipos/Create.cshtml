@model Domain.Equipo
@using System.Linq
@{
    ViewData["Title"] = "Crear Equipo";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var salas = ViewBag.Salas as SelectList ?? new SelectList(new List<Domain.Sala>(), "Id", "Numero");
}

<h2 class="page-title">Crear Equipos</h2>

<div style="display: flex; gap: 20px; margin-bottom: 20px;">
    <button type="button" class="btn-nuevo" onclick="mostrarFormulario('individual')" id="btnIndividual" style="border: none; cursor: pointer;">Creación Individual</button>
    <button type="button" class="btn-nuevo" onclick="mostrarFormulario('masiva')" id="btnMasiva" style="border: none; cursor: pointer; background: #6c757d;">Creación Masiva</button>
</div>

<!-- Formulario Individual -->
<div id="formIndividual" style="max-width: 600px;">
    <h3 style="color: #2c3e50; margin-bottom: 20px;">Crear Equipo Individual</h3>
    
    @if (!ViewData.ModelState.IsValid)
    {
        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
            <strong>Errores de validación:</strong>
            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
        </div>
    }
    
    <form asp-action="Create" method="post">
        @Html.AntiForgeryToken()
        
        <div style="margin-bottom: 20px;">
            <label asp-for="Nombre" style="display: block; font-weight: 600; margin-bottom: 5px;">Nombre del Equipo (opcional - se generará ID automático si se deja vacío)</label>
            <input asp-for="Nombre" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" />
            <span asp-validation-for="Nombre" style="color: #dc3545;"></span>
            <small style="color: #666;">Si deja vacío, se generará un ID automático (ej: EQU-12345678)</small>
        </div>

        <div style="margin-bottom: 20px;">
            <label asp-for="SalaId" style="display: block; font-weight: 600; margin-bottom: 5px;">Sala *</label>
            <select asp-for="SalaId" asp-items="salas" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" required>
                <option value="">-- Seleccione una sala --</option>
            </select>
            <span asp-validation-for="SalaId" style="color: #dc3545;"></span>
        </div>

        <div style="margin-bottom: 20px;">
            <label asp-for="Ubicacion" style="display: block; font-weight: 600; margin-bottom: 5px;">Ubicación *</label>
            <input asp-for="Ubicacion" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" required />
            <span asp-validation-for="Ubicacion" style="color: #dc3545;"></span>
        </div>

        <div style="margin-bottom: 20px;">
            <label asp-for="Estado" style="display: block; font-weight: 600; margin-bottom: 5px;">Estado</label>
            <select asp-for="Estado" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="Libre">Libre</option>
                <option value="Asignado">Asignado</option>
                <option value="Bloqueado">Bloqueado</option>
            </select>
            <span asp-validation-for="Estado" style="color: #dc3545;"></span>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input asp-for="Disponible" type="checkbox" checked style="width: 20px; height: 20px; cursor: pointer;" />
                <span style="font-weight: 600;">Disponible</span>
            </label>
            <span asp-validation-for="Disponible" style="color: #dc3545;"></span>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button type="submit" class="btn-nuevo" style="border: none; cursor: pointer;">Crear Equipo</button>
            <a asp-action="Index" style="padding: 10px 20px; background: #6c757d; color: white; border-radius: 6px; text-decoration: none; display: inline-block;">Cancelar</a>
        </div>
    </form>
</div>

<!-- Formulario Masivo -->
<div id="formMasiva" style="max-width: 600px; display: none;">
    <h3 style="color: #2c3e50; margin-bottom: 20px;">Crear Equipos de Manera Masiva</h3>
    <form id="formMasivo" onsubmit="crearMasivo(event)">
        @Html.AntiForgeryToken()
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 5px;">Sala *</label>
            <select id="salaIdMasiva" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" required>
                <option value="">-- Seleccione una sala --</option>
                @foreach (var item in salas)
                {
                    <option value="@item.Value">@item.Text</option>
                }
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 5px;">Ubicación *</label>
            <input type="text" id="ubicacionMasiva" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" required />
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 5px;">Cantidad de Equipos *</label>
            <input type="number" id="cantidadMasiva" min="1" max="100" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" required />
            <small style="color: #666;">Máximo 100 equipos por operación</small>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 5px;">Estado Inicial</label>
            <select id="estadoMasiva" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="Libre">Libre</option>
                <option value="Asignado">Asignado</option>
                <option value="Bloqueado">Bloqueado</option>
            </select>
        </div>

        <div style="background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
            <strong>Nota:</strong> Cada equipo se creará con un ID único automático (ej: EQU-12345678). No se requiere nombre.
        </div>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button type="submit" class="btn-nuevo" style="border: none; cursor: pointer;">Crear Equipos</button>
            <a asp-action="Index" style="padding: 10px 20px; background: #6c757d; color: white; border-radius: 6px; text-decoration: none; display: inline-block;">Cancelar</a>
        </div>
    </form>
</div>

<div id="mensajeResultado" style="margin-top: 20px; display: none;"></div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        function mostrarFormulario(tipo) {
            if (tipo === 'individual') {
                document.getElementById('formIndividual').style.display = 'block';
                document.getElementById('formMasiva').style.display = 'none';
                document.getElementById('btnIndividual').style.background = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';
                document.getElementById('btnMasiva').style.background = '#6c757d';
            } else {
                document.getElementById('formIndividual').style.display = 'none';
                document.getElementById('formMasiva').style.display = 'block';
                document.getElementById('btnMasiva').style.background = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';
                document.getElementById('btnIndividual').style.background = '#6c757d';
            }
        }

        function crearMasivo(event) {
            event.preventDefault();
            
            var salaId = document.getElementById('salaIdMasiva').value;
            var ubicacion = document.getElementById('ubicacionMasiva').value;
            var cantidad = document.getElementById('cantidadMasiva').value;
            var estado = document.getElementById('estadoMasiva').value;
            var token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            $.ajax({
                url: '@Url.Action("CreateMasivo", "Equipos")',
                method: 'POST',
                data: {
                    salaId: salaId,
                    ubicacion: ubicacion,
                    cantidad: cantidad,
                    estado: estado,
                    __RequestVerificationToken: token
                },
                success: function(response) {
                    var mensajeDiv = document.getElementById('mensajeResultado');
                    if (response.success) {
                        mensajeDiv.style.display = 'block';
                        mensajeDiv.style.background = '#d4edda';
                        mensajeDiv.style.color = '#155724';
                        mensajeDiv.style.padding = '15px';
                        mensajeDiv.style.borderRadius = '4px';
                        mensajeDiv.style.border = '1px solid #c3e6cb';
                        mensajeDiv.innerHTML = '<strong>Éxito:</strong> ' + response.message + '<br><a href="@Url.Action("Index", "Equipos")">Ver equipos creados</a>';
                        
                        // Limpiar formulario
                        document.getElementById('formMasivo').reset();
                        
                        // Redirigir después de 2 segundos
                        setTimeout(function() {
                            window.location.href = '@Url.Action("Index", "Equipos")';
                        }, 2000);
                    } else {
                        mensajeDiv.style.display = 'block';
                        mensajeDiv.style.background = '#f8d7da';
                        mensajeDiv.style.color = '#721c24';
                        mensajeDiv.style.padding = '15px';
                        mensajeDiv.style.borderRadius = '4px';
                        mensajeDiv.style.border = '1px solid #f5c6cb';
                        mensajeDiv.innerHTML = '<strong>Error:</strong> ' + response.message;
                    }
                },
                error: function() {
                    var mensajeDiv = document.getElementById('mensajeResultado');
                    mensajeDiv.style.display = 'block';
                    mensajeDiv.style.background = '#f8d7da';
                    mensajeDiv.style.color = '#721c24';
                    mensajeDiv.style.padding = '15px';
                    mensajeDiv.style.borderRadius = '4px';
                    mensajeDiv.style.border = '1px solid #f5c6cb';
                    mensajeDiv.innerHTML = '<strong>Error:</strong> Ocurrió un error al crear los equipos';
                }
            });
        }
    </script>
}

